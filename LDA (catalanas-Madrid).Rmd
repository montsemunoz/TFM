---
title: "LDA"
author: "Montse Muñoz Aragón"
date: "25/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE, warning=FALSE}
library(stringr)
library(devtools)
library(dplyr)
library(purrr)
library(tidyr)
library(stopwords)
library(tm)
library(quanteda)
library(e1071)
library(readxl)
library(lubridate)
library(ggplot2)
library(wordcloud)
library(RColorBrewer)
library(gridExtra)
library(scales)
library(tidytext)
library(igraph)
library(ggraph)
library(forcats)
library(topicmodels)
library(textmineR)
library(BullsEyeR)
library(ldatuning)
```

```{r}
load("Limpieza datos y análisis (catalanas-Madrid).RData")
```

```{r}
corpus <- Corpus(VectorSource(M$palabras))

doc.lengths <- rowSums(as.matrix(DocumentTermMatrix(corpus)))
dtm <- DocumentTermMatrix(corpus[doc.lengths > 0]) #documents== tweets cada partido, terms== palabras
```

By default α is estimated (estimate.alpha =TRUE) and the starting value for α is 50/k as suggested by Griffiths and Steyvers (2004).
If α is not estimated, it is held fixed at the initial value. If the term distributions for the topics are already given by a previously fitted model, only the topic distributions for documents can be estimated using estimate.beta = FALSE. This is useful for example if a fitted model is evaluated on hold-out data or for new data.

##### Gibbs

###### Determinar el número de tópicos

```{r}
result <- FindTopicsNumber(
dtm,
topics = seq(from = 2, to = 14, by = 1),
metrics = c("Griffiths2004", "CaoJuan2009", "Arun2010", "Deveaud2014"),
method = "Gibbs",
control = list(seed = 77),
mc.cores = NA,
verbose = TRUE)
```

```{r}
FindTopicsNumber_plot(result)
```

De 6 a 10

###### LDA

```{r}
lda_6g <- LDA(dtm, k = 6, method = 'Gibbs', control = list(seed = list(1505)))
lda_7g <- LDA(dtm, k = 7, method = 'Gibbs', control = list(seed = list(1505)))
lda_8g <- LDA(dtm, k = 8, method = 'Gibbs', control = list(seed = list(1505)))
lda_9g <- LDA(dtm, k = 9, method = 'Gibbs', control = list(seed = list(1505)))
lda_10g <- LDA(dtm, k = 10, method = 'Gibbs', control = list(seed = list(1505)))
```

```{r}
terms(lda_6g,15)
terms(lda_7g,15)
terms(lda_8g,15)
terms(lda_9g,15)
terms(lda_10g,15)
```

- Probabilidad de que una palabra pertenezca a un tópico

```{r}
lda_td6g <- tidy(lda_6g, matrix = "beta")
lda_td7g <- tidy(lda_7g, matrix = "beta")
lda_td8g <- tidy(lda_8g, matrix = "beta")
lda_td9g <- tidy(lda_9g, matrix = "beta")
lda_td10g <- tidy(lda_10g, matrix = "beta")
```

```{r}
terminos_frecuentes6g <- lda_td6g %>% group_by(topic) %>%  ungroup() %>% arrange(topic, -beta)
top6g <- terminos_frecuentes6g %>% group_by(topic) %>% top_n(10, beta)

terminos_frecuentes7g <- lda_td7g %>% group_by(topic) %>% ungroup() %>% arrange(topic, -beta)
top7g <- terminos_frecuentes7g %>% group_by(topic) %>% top_n(10, beta) 

terminos_frecuentes8g <- lda_td8g %>% group_by(topic) %>% ungroup() %>% arrange(topic, -beta)
top8g <- terminos_frecuentes8g %>% group_by(topic) %>% top_n(10, beta) 

terminos_frecuentes9g <- lda_td9g %>% group_by(topic) %>% ungroup() %>% arrange(topic, -beta)
top9g <- terminos_frecuentes9g %>% group_by(topic) %>% top_n(10, beta) 

terminos_frecuentes10g <- lda_td10g %>% group_by(topic) %>% ungroup() %>% arrange(topic, -beta)
top10g <- terminos_frecuentes10g %>% group_by(topic) %>% top_n(10, beta)
```

- Entropía palabras por tópico

```{r}
sum <- 0
v <- c()

top <- c(1:6)

for( i in 1:length(top)){
  
  topico <- terminos_frecuentes10g[terminos_frecuentes10g$topic==i,]
  
  for (j in 1:nrow(topico)){
  
    sum <- sum + (topico$beta[j]*log(1/topico$beta[j], base=2))
  }
  
  v <- c(v,sum)
  sum <- 0
}
v
```

###### Histograma

```{r}
ap_top_terms6g <- lda_td6g %>% group_by(topic) %>% slice_max(beta, n = 10) %>% ungroup() %>% arrange(topic, -beta)

ap_top_terms6g %>% mutate(term = reorder_within(term, beta, topic)) %>% ggplot(aes(beta, term, fill = factor(topic))) +
geom_col(show.legend = FALSE) + facet_wrap(~ topic, scales = "free") + scale_y_reordered()
```

```{r}
ap_top_terms7g <- lda_td7g %>% group_by(topic) %>% slice_max(beta, n = 10) %>% ungroup() %>% arrange(topic, -beta)

ap_top_terms7g %>% mutate(term = reorder_within(term, beta, topic)) %>% ggplot(aes(beta, term, fill = factor(topic))) +
geom_col(show.legend = FALSE) + facet_wrap(~ topic, scales = "free") + scale_y_reordered()
```

```{r}
ap_top_terms8g <- lda_td8g %>% group_by(topic) %>% slice_max(beta, n = 10) %>% ungroup() %>% arrange(topic, -beta)

ap_top_terms8g %>% mutate(term = reorder_within(term, beta, topic)) %>% ggplot(aes(beta, term, fill = factor(topic))) +
geom_col(show.legend = FALSE) + facet_wrap(~ topic, scales = "free", ncol=4) + scale_y_reordered()
```

```{r}
ap_top_terms9g <- lda_td9g %>% group_by(topic) %>% slice_max(beta, n = 10) %>% ungroup() %>% arrange(topic, -beta)

ap_top_terms9g %>% mutate(term = reorder_within(term, beta, topic)) %>% ggplot(aes(beta, term, fill = factor(topic))) +
geom_col(show.legend = FALSE) + facet_wrap(~ topic, scales = "free") + scale_y_reordered()
```

```{r}
ap_top_terms10g <- lda_td10g %>% group_by(topic) %>% slice_max(beta, n = 10) %>% ungroup() %>% arrange(topic, -beta)

ap_top_terms10g %>% mutate(term = reorder_within(term, beta, topic)) %>% ggplot(aes(beta, term, fill = factor(topic))) +
geom_col(show.legend = FALSE) + facet_wrap(~ topic, scales = "free", ncol=5) + scale_y_reordered()
```

- Probabilidad de que un documento pertenzeca a un tópico

```{r}
lda_gamma6g <- tidy(lda_6g, matrix = "gamma")
lda_gamma7g <- tidy(lda_7g, matrix = "gamma")
lda_gamma8g <- tidy(lda_8g, matrix = "gamma")
lda_gamma9g <- tidy(lda_9g, matrix = "gamma")
lda_gamma10g <- tidy(lda_10g, matrix = "gamma")
```

- Entropía tópicos por documento

```{r}
sum <- 0
v <- c()

doc <- c(1:5)

for( i in 1:length(doc)){
  
  documento <- lda_gamma6g[lda_gamma6g$document==i,]
  
  for (j in 1:nrow(documento)){
  
    sum <- sum + (documento$gamma[j]*log(1/documento$gamma[j], base=2))
  }
  
  v <- c(v,sum)
  sum <- 0
}
v
```

- Heatmap

```{r}
topics <- topicmodels::posterior(lda_6g, dtm)[["topics"]]
rownames(topics) <- c("VOX","PP","Ciudadanos","PSOE","Podemos")
colnames(topics) <- c("Tópico 1","Tópico 2","Tópico 3","Tópico 4","Tópico 5","Tópico 6")
colores <- colorRampPalette(c("grey", "white", "steelblue"))(256)
heatmap(topics, scale = "none",col=colores)
```

##### Inferencia variacional

- Probabilidad de que una palabra pertenezca a un tópico

```{r}
lda_6i <- LDA(dtm, k = 6, method = 'VEM', control = list(seed = list(1505)))
lda_7i <- LDA(dtm, k = 7, method = 'VEM', control = list(seed = list(1505)))
lda_8i <- LDA(dtm, k = 8, method = 'VEM', control = list(seed = list(1505)))
lda_9i <- LDA(dtm, k = 9, method = 'VEM', control = list(seed = list(1505)))
lda_10i <- LDA(dtm, k = 10, method = 'VEM', control = list(seed = list(1505)))
```

```{r}
terms(lda_6i,5)
terms(lda_7i,5)
terms(lda_8i,5)
terms(lda_9i,5)
terms(lda_10i,5)
```

```{r}
lda_td6i <- tidy(lda_6i, matrix = "beta")
lda_td6i <- tidy(lda_7i, matrix = "beta")
lda_td8i <- tidy(lda_8i, matrix = "beta")
lda_td6i <- tidy(lda_9i, matrix = "beta")
lda_td10i <- tidy(lda_10i, matrix = "beta")
```

```{r}
terminos_frecuentes6i <- lda_td6i %>% group_by(topic) %>% top_n(10, beta) %>% ungroup() %>% arrange(topic, -beta)
terminos_frecuentes7i <- lda_td7i %>% group_by(topic) %>% top_n(10, beta) %>% ungroup() %>% arrange(topic, -beta)
terminos_frecuentes8i <- lda_td8i %>% group_by(topic) %>% top_n(10, beta) %>% ungroup() %>% arrange(topic, -beta)
terminos_frecuentes9i <- lda_td9i %>% group_by(topic) %>% top_n(10, beta) %>% ungroup() %>% arrange(topic, -beta)
terminos_frecuentes10i <- lda_td10i %>% group_by(topic) %>% top_n(10, beta) %>% ungroup() %>% arrange(topic, -beta)
```

```{r}
ap_top_terms6i <- lda_td6i %>% group_by(topic) %>% slice_max(beta, n = 10) %>% ungroup() %>% arrange(topic, -beta)

ap_top_terms6i %>% mutate(term = reorder_within(term, beta, topic)) %>% ggplot(aes(beta, term, fill = factor(topic))) +
geom_col(show.legend = FALSE) + facet_wrap(~ topic, scales = "free", ncol=4) + scale_y_reordered()
```

```{r}
ap_top_terms7i <- lda_td7i %>% group_by(topic) %>% slice_max(beta, n = 10) %>% ungroup() %>% arrange(topic, -beta)

ap_top_terms7i %>% mutate(term = reorder_within(term, beta, topic)) %>% ggplot(aes(beta, term, fill = factor(topic))) +
geom_col(show.legend = FALSE) + facet_wrap(~ topic, scales = "free", ncol=4) + scale_y_reordered()
```

```{r}
ap_top_terms8i <- lda_td8i %>% group_by(topic) %>% slice_max(beta, n = 10) %>% ungroup() %>% arrange(topic, -beta)

ap_top_terms8i %>% mutate(term = reorder_within(term, beta, topic)) %>% ggplot(aes(beta, term, fill = factor(topic))) +
geom_col(show.legend = FALSE) + facet_wrap(~ topic, scales = "free", ncol=4) + scale_y_reordered()
```

```{r}
ap_top_terms9i <- lda_td9i %>% group_by(topic) %>% slice_max(beta, n = 10) %>% ungroup() %>% arrange(topic, -beta)

ap_top_terms9i %>% mutate(term = reorder_within(term, beta, topic)) %>% ggplot(aes(beta, term, fill = factor(topic))) +
geom_col(show.legend = FALSE) + facet_wrap(~ topic, scales = "free", ncol=5) + scale_y_reordered()
```

```{r}
ap_top_terms10i <- lda_td10i %>% group_by(topic) %>% slice_max(beta, n = 10) %>% ungroup() %>% arrange(topic, -beta)

ap_top_terms10i %>% mutate(term = reorder_within(term, beta, topic)) %>% ggplot(aes(beta, term, fill = factor(topic))) +
geom_col(show.legend = FALSE) + facet_wrap(~ topic, scales = "free", ncol=5) + scale_y_reordered()
```


- Probabilidad de que un documento pertenzeca a un tópico

```{r}
lda_gamma6i <- tidy(lda_6i, matrix = "gamma")
lda_gamma8i <- tidy(lda_8i, matrix = "gamma")
lda_gamma10i <- tidy(lda_10i, matrix = "gamma")
lda_gamma12i <- tidy(lda_12i, matrix = "gamma")
lda_gamma14i <- tidy(lda_14i, matrix = "gamma")
```



